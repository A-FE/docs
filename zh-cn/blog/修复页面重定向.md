# 修复SameSite=None引起重定向次数过多的问题

## 问题描述
chrome浏览器80+版本，部分用户无法登录系统，页面显示重定向次数过多。
![image](https://user-images.githubusercontent.com/18495604/84108514-f4d71d00-aa52-11ea-951d-33f70f04a964.png)

## 原因
chrome 80+版本的浏览器, 提升了Cookie SameSite的默认安全等级。

`SameSite`有三个可选值, `Strict | Lax | None`, 没个值对应的cookie策略不一样，详情见[Cookie 的 SameSite 属性](http://www.ruanyifeng.com/blog/2019/09/cookie-samesite.html)

低于 chrome 80版本的浏览器，`SameSite`的默认值为`None`,  并且在http/https协议下，发送请求，都会默认带上当前域名下的cookie。

但是在高于chrome 80版本的浏览器, `SameSite=None` 只在https协议下生效, 并且`SameSite 默认值变成了Lax `。

## 解决办法

1. 维护两套cookie
* 之前的那套cookie设置/校验不用改，用来兼容低于chrome 80版本的浏览器和不支持SameSite的浏览器
```
Set-Cookie: widget_session=abc123;
```

* 增加一个新的cookie值, 用来兼容高于chrome 80版本的浏览器
```
Set-Cookie: widget_session_secure=abc123; SameSite=None; Secure
```
以上配置, 仅在https协议, chrome 80+版本浏览器中生效。

2. 从cookie中取值时，依次从`widget_session`、`widget_session_secure`里面取值。

## 总结
修复这个问题，需要兼容三种浏览器, 同时还要兼容之前的页面配置, 针对chrome 80+版本的浏览器，单独设置一个cookie, 是一个比较好的解决方案

