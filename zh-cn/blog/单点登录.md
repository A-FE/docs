# 单点登录

## 为什么要了解单点登录
作为一名前端工程师，单点登录好像与我们没什么交集, 一般我们只需要申请，按照文档接入，就能
完成需求。

如果工作中接触到node中间层、中间件开发，精通单点登录就非常有必要了。

据一位不知名的朋友的透露，他们公司的单点登录系统做得不够严谨, 利用系统的漏洞, 无需账号密码，就能悄无声息的登录了他老板、还有CTO的账号......, 幸好他及时帮助公司修复了这个bug, 避免了公司被“浑水”做空的潜在风险，为公司挽回了几百亿的损失。

## 什么是单点登录
单点登录（Single Sign On），简称为 SSO，是比较流行的企业业务整合的解决方案之一。SSO的定义是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统。

## 单点登录的流程
![image](https://user-images.githubusercontent.com/18495604/84055654-ba846600-a9e7-11ea-966f-5f3efbb209ca.png)
上图是CAS官网上的标准流程，具体流程如下：

### 用户第一次访问`https://app.example.com`
1. 因为是第一次访问，请求中没有携带证明身份的cookie, app系统将页面重定向到SSO系统。
3. 用户填写用户名、密码，SSO系统进行认证后，将登录状态写入SSO的session，浏览器（Browser）中写入SSO域(cas.example.com)下的Cookie(`CASTGC=TGC-1234567`)
4. SSO系统登录完成后会生成一个ST（Service Ticket），并将ST写入session, 同时设置SSO域名的cookie中(`CASTGC=TGC-2345678`)。然后重定向到`https://app.example.com/?ticket=ST-12345678`.
5. app系统从URL中拿到ST后，向SSO发送请求，验证ST是否有效。验证通过后，app系统将登录状态写入session, 并设置app域(`app.example.com`)下的Cookie(`JSESSION=abc1234567`)

### 用户第二次访问`https://app.example.com/resource`
1. 浏览器请求`https://app.example.com/resource`, 会自动携带当前域名下的cookie `JSESSION=abc1234567`.
2. app系统拿到cookie中`JSESSION`, 会去session服务校验cookie的有效性。
* 校验成功，会返回对应的资源; 
* 校验失败，则会重定向到SSO登录页，重复第一次登录的过程。

### 用户接着访问另一个系统`https://app2.example.com/resource`
1. 浏览器请求`https://app2.example.com/resource`, app2系统从cookie中没有拿到用户登录的凭证，将页面重定向到SSO登录页.
2. 浏览器重定向到`https://cas.example.com/cas/login?server=https://app2.example.com/resource`,会自动携带上一次设置的cookie`CASTGC=TGC-2345678`
3. SSO系统校验CASTGC, 校验通过，生成ticket, 将页面重定向到`https://app2.example.com/?ticket=ST-345678`.
4.  app2系统从URL中拿到ST后，向SSO发送请求，验证ST是否有效。验证通过后，app2系统将登录状态写入session, 并设置app2域(`app2.example.com`)下的Cookie(`JSESSION=XYZ1234567`)

## 总结
以上就是单点登录的主要流程，各大公司在实现上可能略有差异，原理基本一致。
